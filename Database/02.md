# âœ¨ Database

## ğŸ“Œ A many-to-one relationship

##### ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ì—ì„œì˜ ì™¸ë˜ í‚¤ ì†ì„±ì„ ì‚¬ìš©í•´ ëª¨ë¸ê°„ N:1 ê´€ê³„ ì„¤ì •í•˜ê¸°

#### ğŸ“¢ RDBì—ì„œì˜ ê´€ê³„

1. **1:1**

   - One-to-one relationships
   - í•œ í…Œì´ë¸”ì˜ ë ˆì½”ë“œ í•˜ë‚˜ê°€ ë‹¤ë¥¸ í…Œì´ë¸”ì˜ ë ˆì½”ë“œ ë‹¨ í•œ ê°œì™€ ê´€ë ¨ëœ ê²½ìš°

2. **N:1**

   - Many-to-one relationships
   - í•œ í…Œì´ë¸”ì˜ 0ê°œ ì´ìƒì˜ ë ˆì½”ë“œê°€ ë‹¤ë¥¸ í…Œì´ë¸”ì˜ ë ˆì½”ë“œ í•œ ê°œì™€ ê´€ë ¨ëœ ê²½ìš°
   - ê¸°ì¤€ í…Œì´ë¸”ì— ë”°ë¼ (1:N, One-to-many relationships)ì´ë¼ê³ ë„ í•¨
   - **ë§Œì•½ ê³ ê°ì´ ë‹¨ í•œ ê°œì˜ ì£¼ë¬¸ë§Œ ìƒì„±í•  ìˆ˜ ìˆë‹¤ë©´ ë‘ í…Œì´ë¸”ì€ 1:1 ê´€ê³„ë¼ í•  ìˆ˜ ìˆìŒ**

3. **M:N**

   - Many-to-many relationships
   - í•œ í…Œì´ë¸”ì˜ 0ê°œ ì´ìƒì˜ ë ˆì½”ë“œê°€ ë‹¤ë¥¸ í…Œì´ë¸”ì˜ 0ê°œ ì´ìƒì˜ ë ˆì½”ë“œì™€ ê´€ë ¨ëœ ê²½ìš°
   - ì–‘ìª½ ëª¨ë‘ì—ì„œ N:1 ê´€ê³„ë¥¼ ê°€ì§

   

### ğŸ’¡ Foreign Key (ì™¸ë˜ í‚¤)

#### [ê°œë…]

- ì™¸ë˜ í‚¤ (ì™¸ë¶€ í‚¤)
- ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í•œ í…Œì´ë¸”ì˜ í•„ë“œ ì¤‘ ë‹¤ë¥¸ í…Œì´ë¸”ì˜ í–‰ì„ ì‹ë³„í•  ìˆ˜ ìˆëŠ” í‚¤
- ì°¸ì¡°í•˜ëŠ” í…Œì´ë¸”ì—ì„œ 1ê°œì˜ í‚¤ì— í•´ë‹¹í•˜ê³ , ì´ëŠ” ì°¸ì¡°ë˜ëŠ” ì¸¡ í…Œì´ë¸”ì˜ ê¸°ë³¸ í‚¤(Primary Key)ë¥¼ ê°€ë¦¬í‚´
- ì°¸ì¡°í•˜ëŠ” í…Œì´ë¸”ì˜ í–‰ 1ê°œì˜ ê°’ì€, ì°¸ì¡°ë˜ëŠ” ì¸¡ í…Œì´ë¸”ì˜ í–‰ ê°’ì— ëŒ€ì‘ë¨
  - ì´ ë•Œë¬¸ì— ì°¸ì¡°í•˜ëŠ” í…Œì´ë¸”ì˜ í–‰ì—ëŠ”, ì°¸ì¡°ë˜ëŠ” í…Œì´ë¸”ì— ë‚˜íƒ€ë‚˜ì§€ ì•ŠëŠ” ê°’ì„ í¬í•¨í•  ìˆ˜ ì—†ìŒ
- ì°¸ì¡°í•˜ëŠ” í…Œì´ë¸” í–‰ ì—¬ëŸ¬ ê°œê°€, ì°¸ì¡°ë˜ëŠ” í…Œì´ë¸”ì˜ ë™ì¼í•œ í–‰ì„ ì°¸ì¡°í•  ìˆ˜ ìˆìŒ



#### [íŠ¹ì§•]

- í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¶€ëª¨ í…Œì´ë¸”ì˜ ìœ ì¼í•œ ê°’ì„ ì°¸ì¡° (by ì°¸ì¡° ë¬´ê²°ì„±)
- ì™¸ë˜ í‚¤ì˜ ê°’ì´ ë°˜ë“œì‹œ ë¶€ëª¨ í…Œì´ë¸”ì˜ ê¸°ë³¸ í‚¤ ì¼ í•„ìš”ëŠ” ì—†ì§€ë§Œ ìœ ì¼í•œ ê°’ì´ì–´ì•¼ í•¨



#### [ì°¸ì¡°] ì°¸ì¡° ë¬´ê²°ì„±

- ë°ì´í„°ë² ì´ìŠ¤ ê´€ê³„ ëª¨ë¸ì—ì„œ ê´€ë ¨ëœ 2ê°œì˜ í…Œì´ë¸” ê°„ì˜ ì¼ê´€ì„±ì„ ë§í•¨
- ì™¸ë˜ í‚¤ê°€ ì„ ì–¸ëœ í…Œì´ë¸”ì˜ ì™¸ë˜ í‚¤ ì†ì„±(ì—´)ì˜ ê°’ì€ ê·¸ í…Œì´ë¸”ì˜ ë¶€ëª¨ê°€ ë˜ëŠ” í…Œì´ë¸”ì˜ ê¸°ë³¸ í‚¤ ê°’ìœ¼ë¡œ ì¡´ì¬í•´ì•¼ í•¨



## ğŸ“Œ N:1 (Comment - Article)

- Comment(N) - Article(1)
  - Comment ëª¨ë¸ê³¼ Article ëª¨ë¸ ê°„ ê´€ê³„ ì„¤ì •
- "0ê°œ ì´ìƒì˜ ëŒ“ê¸€ì€ 1ê°œì˜ ê²Œì‹œê¸€ì— ì‘ì„±ë  ìˆ˜ ìˆìŒ"



### ğŸ’¡ ëª¨ë¸ ê´€ê³„ ì„¤ì •

- N:1 ê´€ê³„ì—ì„œ ëŒ“ê¸€ì„ ë‹´ë‹¹í•  Comment ëª¨ë¸ì€ N, Article ëª¨ë¸ì€ 1ì´ ë  ê²ƒ

  ![image-20221005094342454](C:\Users\Bokyeong\AppData\Roaming\Typora\typora-user-images\image-20221005094342454.png)



### ğŸ’¡ Django Relationship fields

#### [Django Relationship fields ì¢…ë¥˜]

1. `OneToOneField()`
   - A one-to-one relationship
2. `ForeignKey()`
   - A many-to-one relationship
3. `ManyToManyField()`
   - A many-to-many relationship



#### ğŸ“¢ ForeignKey (to, on_delete, **options)

- A many-to-one relationship ì„ ë‹´ë‹¹í•˜ëŠ” Djangoì˜ ëª¨ë¸ í•„ë“œ í´ë˜ìŠ¤
- Django ëª¨ë¸ì—ì„œ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ì˜ ì™¸ë˜ í‚¤ ì†ì„±ì„ ë‹´ë‹¹
- 2ê°œì˜ í•„ìˆ˜ ìœ„ì¹˜ ì¸ìê°€ í•„ìš”
  1. ì°¸ì¡°í•˜ëŠ” `model class`
  2. `on-delete` ì˜µì…˜



### ğŸ’¡ Comment Model

#### ğŸ“¢ Comment ëª¨ë¸ ì •ì˜

```python
class Comment(models.Model):
    article = models.ForeignKey(Article, on_delete=models.CASCADE)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self):
        return self.content
```

- ì™¸ë˜ í‚¤ í•„ë“œëŠ” ForeignKey í´ë˜ìŠ¤ë¥¼ ì‘ì„±í•˜ëŠ” ìœ„ì¹˜ì™€ ê´€ê³„ ì—†ì´ í•„ë“œì˜ ë§ˆì§€ë§‰ì— ì‘ì„±ë¨
- `ForeignKey()` í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ ì´ë¦„ì€ ì°¸ì¡°í•˜ëŠ” ëª¨ë¸ í´ë˜ìŠ¤ ì´ë¦„ì˜ ë‹¨ìˆ˜í˜•(ì†Œë¬¸ì)ìœ¼ë¡œ ì‘ì„±í•˜ëŠ” ê²ƒì„ ê¶Œì¥



#### ğŸ“¢ ForeignKey arguments - `on_delete`

- ì™¸ë˜ í‚¤ê°€ ì°¸ì¡°í•˜ëŠ” ê°ì²´ê°€ ì‚¬ë¼ì¡Œì„ ë•Œ, ì™¸ë˜ í‚¤ë¥¼ ê°€ì§„ ê°ì²´ë¥¼ ì–´ë–»ê²Œ ì²˜ë¦¬í•  ì§€ë¥¼ ì •ì˜
- ë°ì´í„° ë¬´ê²°ì„±ì„ ìœ„í•´ì„œ ë§¤ìš° ì¤‘ìš”í•œ ì„¤ì •
- on_delete ì˜µì…˜ ê°’
  - `CASCADE` : ë¶€ëª¨ ê°ì²´ (ì°¸ì¡° ëœ ê°ì²´)ê°€ ì‚­ì œëì„ ë•Œ ì´ë¥¼ ì°¸ì¡°í•˜ëŠ” ê°ì²´ë„ ì‚­ì œ
  - `PROTECT`, `SET_NULL`, `SET_DEFAULT` ... ë“± ì—¬ëŸ¬ ì˜µì…˜ ê°’ë“¤ì´ ì¡´ì¬



#### [ì°¸ê³ ] ë°ì´í„° ë¬´ê²°ì„± (Data Integrity)

- ë°ì´í„°ì˜ ì •í™•ì„±ê³¼ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ê³  ë³´ì¦í•˜ëŠ” ê²ƒ
- ë°ì´í„°ë² ì´ìŠ¤ë‚˜ RDBMSì˜ ì¤‘ìš”í•œ ê¸°ëŠ¥
- ë¬´ê²°ì„± ì œí•œì˜ ìœ í˜•
  1. ê°œì²´ ë¬´ê²°ì„± (Entity integrity)
  2. ì°¸ì¡° ë¬´ê²°ì„± (Referential integrity)
  3. ë²”ìœ„ ë¬´ê²°ì„± (Domain integrity)



#### ğŸ“¢ Migration ê³¼ì • ì§„í–‰

```bash
$ python manage.py makemigrations
$ python manage.py migrate
```

- ForeignKey ëª¨ë¸ í•„ë“œë¡œ ì¸í•´ ì‘ì„±ëœ ì»¬ëŸ¼ì˜ ì´ë¦„ì´ `article_id`ì¸ ê²ƒì„ í™•ì¸
- ë§Œì•½ ForeignKey ì¸ìŠ¤í„´ìŠ¤ë¥¼ articleì´ ì•„ë‹Œ abcdë¡œ ìƒì„±í–ˆë‹¤ë©´ abcd_idë¡œ ë§Œë“¤ì–´ì§
  - ì´ì²˜ëŸ¼ ëª…ì‹œì ì¸ ëª¨ë¸ ê´€ê³„ë¥¼ íŒŒì•…ì„ ìœ„í•´ ì°¸ì¡°í•˜ëŠ” í´ë˜ìŠ¤ ì´ë¦„ì˜ ì†Œë¬¸ì(ë‹¨ìˆ˜í˜•)ë¡œ ì‘ì„±í•˜ëŠ” ê²ƒì´ ê¶Œì¥ ë˜ì—ˆë˜ ì´ìœ 



#### ğŸ“¢ ëŒ“ê¸€ ìƒì„± ì—°ìŠµí•˜ê¸°

```bash
# shell_plus ì‹¤í–‰
$ python manage.py shell_plus
```

1. ëŒ“ê¸€ ìƒì„±

```bash
# Comment í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ comment ìƒã…‡ì„±
comment = Comment()

# ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ ì €ì¥
comment.content = 'first comment'

# DBì— ëŒ“ê¸€ ì €ì¥
comment.save()

#ì—ëŸ¬ ë°œìƒ
django.db.utils.IntegrityError: NOT NULL constraint failed: articles_comment.article_id
# articles_comment í…Œì´ë¸”ì˜ ForeignKeyField, article_id  ê°’ì´ ì €ì¥ì‹œ ëˆ„ë½ë˜ì—ˆê¸° ë•Œë¬¸
```

```bash
# ê²Œì‹œê¸€ ìƒì„± ë° í™•ì¸
article = Article.objects.create(title='title', content='content')
article
=> <Article: title>

# ì™¸ë˜ í‚¤ ë°ì´í„° ì…ë ¥
# ë‹¤ìŒê³¼ ê°™ì´ article ê°ì²´ ìì²´ë¥¼ ë„£ì„ ìˆ˜ ìˆìŒ
comment.article = article
# ë˜ëŠ” comment.article_id = article.pk ì²˜ëŸ¼ pk ê°’ì„ ì§ì ‘ ì™¸ë˜ í‚¤ ì»¬ëŸ¼ì—
# ë„£ì–´ ì¤„ ìˆ˜ë„ ìˆì§€ë§Œ ê¶Œì¥í•˜ì§€ ì•ŠìŒ

# DBì— ëŒ“ê¸€ ì €ì¥ ë° í™•ì¸
comment.save()
comment
=> <Comment: first comment>
```

2. ëŒ“ê¸€ ì†ì„± ê°’ í™•ì¸

```bash
comment.pk
=> 1

comment.content
=> 'first comment'

# í´ë˜ìŠ¤ ë³€ìˆ˜ëª…ì¸ articleë¡œ ì¡°íšŒ ì‹œ í•´ë‹¹ ì°¸ì¡°í•˜ëŠ” ê²Œì‹œë¬¼ ê°ì²´ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŒ
comment.article
=> <Article: title>

# article_pk ëŠ” ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í•„ë“œì´ê¸° ë•Œë¬¸ì— ì‚¬ìš© ë¶ˆê°€
comment.article_id
=> 1
```

3. comment ì¸ìŠ¤í„´ìŠ¤ë¥¼ í†µí•œ article ê°’ ì ‘ê·¼í•˜ê¸°

```bash
# 1ë²ˆ ëŒ“ê¸€ì´ ì‘ì„±ëœ ê²Œì‹œë¬¼ì˜ pk ì¡°íšŒ
comment.article.pk
=> 1

# 1ë²ˆ ëŒ“ê¸€ì´ ì‘ì„±ëœ ê²Œì‹œë¬¼ì˜ content ì¡°íšŒ
comment.article.content
=> 'content'
```

4. ë‘ë²ˆì§¸ ëŒ“ê¸€ ì‘ì„±í•´ë³´ê¸°

```shell
comment = Comment(content='secone comment', article=article)
comment.save()

comment.pk
=> 2

comment
=> <Comment: second comment>

comment.article_id
=> 1
```



### ğŸ’¡ ê´€ê³„ ëª¨ë¸ ì°¸ì¡°

#### ğŸ“¢ Related manager

- Related manager ëŠ” N:1 í˜¹ì€ M:N ê´€ê³„ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ë¬¸ë§¥ (context)
- Django ëŠ” ëª¨ë¸ ê°„ N:1 í˜¹ì€ M:N ê´€ê³„ê°€ ì„¤ì •ë˜ë©´ ì—­ì°¸ì¡°í•  ë•Œì— ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” manager ë¥¼ ìƒì„±
  - ìš°ë¦¬ê°€ ì´ì „ì— ëª¨ë¸ ìƒì„± ì‹œ `objects` ë¼ëŠ” ë§¤ë‹ˆì €ë¥¼ í†µí•´ queryset apië¥¼ ì‚¬ìš©í–ˆë˜ ê²ƒì²˜ëŸ¼ related managerë¥¼ í†µí•´ queryset apië¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë¨



#### ğŸ“¢ ì—­ì°¸ì¡°

- ë‚˜ë¥¼ ì°¸ì¡°í•˜ëŠ” í…Œì´ë¸”(ë‚˜ë¥¼ ì™¸ë˜ í‚¤ë¡œ ì§€ì •í•œ)ì„ ì°¸ì¡°í•˜ëŠ” ê²ƒ
- ì¦‰, ë³¸ì¸ì„ ì™¸ë˜ í‚¤ë¡œ ì°¸ì¡° ì¤‘ì¸ ë‹¤ë¥¸ í…Œì´ë¸”ì— ì ‘ê·¼í•˜ëŠ” ê²ƒ
- N:1 ê´€ê³„ì—ì„œëŠ” 1ì´ Nì„ ì°¸ì¡°í•˜ëŠ” ìƒí™©
  - ì™¸ë˜ í‚¤ë¥¼ ê°€ì§€ì§€ ì•Šì€ 1ì´ ì™¸ë˜ í‚¤ë¥¼ ê°€ì§„ Nì„ ì°¸ì¡°



#### ğŸ“¢ `article.comment_set.method()`

- Article ëª¨ë¸ì´ Comment ëª¨ë¸ì„ ì°¸ì¡°(ì—­ì°¸ì¡°)í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ë§¤ë‹ˆì €
- `article.comment` í˜•ì‹ìœ¼ë¡œëŠ” ëŒ“ê¸€ ê°ì²´ë¥¼ ì°¸ì¡°í•  ìˆ˜ ì—†ìŒ
  - ì‹¤ì œë¡œ Article í´ë˜ìŠ¤ì—ëŠ” Comment ì™€ì˜ ì–´ë– í•œ ê´€ê³„ë„ ì‘ì„±ë˜ì–´ ìˆì§€ ì•ŠìŒ
- ëŒ€ì‹  Django ê°€ ì—­ì°¸ì¡° í•  ìˆ˜ ìˆëŠ” `comment_set` manager ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•´ `article.comment_set` í˜•íƒœë¡œ ëŒ“ê¸€ ê°ì²´ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆìŒ
  - N:1 ê´€ê³„ì—ì„œ ìƒì„±ë˜ëŠ” Related manager ì˜ ì´ë¦„ì€ ì°¸ì¡°í•˜ëŠ” "ëª¨ë¸ëª…_set"ì´ë¦„ ê·œì¹™ìœ¼ë¡œ ë§Œë“¤ì–´ì§

- ë°˜ë©´ ì°¸ì¡° ìƒí™© (Comment â†’ Article) ì—ì„œëŠ” ì‹¤ì œ ForeignKey í´ë˜ìŠ¤ë¡œ ì‘ì„±í•œ ì¸ìŠ¤í„´ìŠ¤ê°€ Comment í´ë˜ìŠ¤ì˜ í´ë˜ìŠ¤ ë³€ìˆ˜ì´ê¸° ë•Œë¬¸ì— comment.article í˜•íƒœë¡œ ì‘ì„± ê°€ëŠ¥



#### ğŸ“¢ Related manager ì—°ìŠµí•˜ê¸°

1. 1ë²ˆ ê²Œì‹œê¸€ ì¡°íšŒí•˜ê¸°

```shell
article = Article.objects.get(pk=1)
```

2. `dir()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ í´ë˜ìŠ¤ ê°ì²´ê°€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë©”ì„œë“œë¥¼ í™•ì¸í•˜ê¸°

```shell
dir(article)

[...
 'comment_set',
 'content',
 'created_at',
 'date_error_message',
 'delete',
 'from_db',
 'full_clean',
...]
```

3. 1ë²ˆ ê²Œì‹œê¸€ì— ì‘ì„±ëœ ëª¨ë“  ëŒ“ê¸€ ì¡°íšŒí•˜ê¸° (ì—­ì°¸ì¡°)

```shell
In [24]: article.comment_set.all()
Out[24]: <QuerySet [<Comment: first comment>, <Comment: second comment>]>
```

4. 1ë²ˆ ê²Œì‹œê¸€ì— ì‘ì„±ëœ ëª¨ë“  ëŒ“ê¸€ ì¶œë ¥í•˜ê¸°

```shell
comments = article.comment_set.all()

for comment in comments:
	print(comment.content)
```



#### ğŸ“¢ ForeignKey arguments - `related_name`

```python
# articles/models.py

class Comment(models.Model):
    article = models.ForeignKey(Article, on_delete=models.CASCADE, related_name='comments')
```

- ForeignKey í´ë˜ìŠ¤ì˜ ì„ íƒ ì˜µì…˜
- ì—­ì°¸ì¡° ì‹œ ì‚¬ìš©í•˜ëŠ” ë§¤ë‹ˆì € ì´ë¦„(model_set manager)ì„ ë³€ê²½í•  ìˆ˜ ìˆìŒ
- ì‘ì„± í›„, migration ê³¼ì •ì´ í•„ìš”
- ì„ íƒ ì˜µì…˜ì´ì§€ë§Œ ìƒí™©ì— ë”°ë¼ ë°˜ë“œì‹œ ì‘ì„±í•´ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ìƒê¸°ê¸°ë„ í•¨



#### ğŸ“¢ admin site ë“±ë¡

- ìƒˆë¡œ ì‘ì„±í•œ Comment ëª¨ë¸ì„ admin siteì— ë“±ë¡í•˜ê¸°

```python
# articles/admin.py

from .models import Article, Comment

admin.site.register(Article)
admin.site.register(Comment)
```



### ğŸ’¡ Comment êµ¬í˜„

#### ğŸ“¢ CREATE

- ì‚¬ìš©ìë¡œë¶€í„° ëŒ“ê¸€ ë°ì´í„°ë¥¼ ì…ë ¥ ë°›ê¸° ìœ„í•œ CommentFrom ì‘ì„±

```python
# articles/forms.py

from .models import Article, Comment

class CommentForm(forms.ModelForm):
    
    class Meta:
        model = Comment
        fields = '__all__'
```

- detail í˜ì´ì§€ì—ì„œ CommentForm ì¶œë ¥ (view í•¨ìˆ˜)

```python
# articles/views.py

from .forms import ArticleForm, CommentForm

def detail(request, pk):
    article = Article.objects.get(pk=pk)
    comment_form = CommentForm()
    context = {
        'article': article,
        'comment_form': comment_form,
    }
    return render(request, 'articles/detail.html', context)
```

- detail í˜ì´ì§€ì—ì„œ CommentForm ì¶œë ¥ (í…œí”Œë¦¿)

```django
<!-- articles/detail.html -->

{% extends 'base.html' %}

{% block content %}
  ...
  <a href="{% url 'articles:index' %}">back</a>
  <hr>
  <form action="#" method="POST">
    {% csrf_token %}
    {{ comment_form }}
    <input type="submit">
  </form>
{% endblock content %}
```

![image-20221005105346232](assets/image-20221005105346232.png)

- detail í˜ì´ì§€ì— ì¶œë ¥ëœ CommentFormì„ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì¶œë ¥ë¨
- ì‹¤ ì„œë¹„ìŠ¤ì—ì„œëŠ” ëŒ“ê¸€ì„ ì‘ì„±í•  ë•Œ ëŒ“ê¸€ì„ ì–´ë–¤ ê²Œì‹œê¸€ì— ì‘ì„±í•˜ëŠ”ì§€ ì§ì ‘ ê²Œì‹œê¸€ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì§€ ì•ŠìŒ
- ì‹¤ì œë¡œëŠ” í•´ë‹¹ ê²Œì‹œê¸€ì— ëŒ“ê¸€ì„ ì‘ì„±í•˜ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ê·¸ ê²Œì‹œê¸€ì— ëŒ“ê¸€ì´ ì‘ì„±ë˜ì–´ì•¼ í•¨
- ë‹¤ìŒê³¼ ê°™ì´ ì¶œë ¥ë˜ëŠ” ì´ìœ ëŠ” Comment í´ë˜ìŠ¤ì˜ ì™¸ë˜ í‚¤ í•„ë“œ article ë˜í•œ ë°ì´í„° ì…ë ¥ì´ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— ì¶œë ¥ë˜ê³  ìˆëŠ” ê²ƒ
- í•˜ì§€ë§Œ, ì™¸ë˜ í‚¤ í•„ë“œëŠ” **ì‚¬ìš©ìì˜ ì…ë ¥ìœ¼ë¡œ ë°›ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ view í•¨ìˆ˜ ë‚´ì—ì„œ ë°›ì•„ ë³„ë„ë¡œ ì²˜ë¦¬ë˜ì–´ ì €ì¥**ë˜ì–´ì•¼ í•¨



- ì™¸ë˜ í‚¤ í•„ë“œë¥¼ ì¶œë ¥ì—ì„œ ì œì™¸ í›„ í™•ì¸

```python
# articles/forms.py

class CommentForm(forms.ModelForm):
    
    class Meta:
        model = Comment
        exclude = ('article',)
```



- ì¶œë ¥ì—ì„œ ì œì™¸ëœ ì™¸ë˜ í‚¤ ë°ì´í„°ëŠ” ì–´ë””ì„œ ë°›ì•„ì™€ì•¼ í• ê¹Œ ?
- detail í˜ì´ì§€ì˜ url ì„ ì‚´í´ë³´ë©´ `path('<int:pk>/', views.detail, name='detail')` 
  url ì— í•´ë‹¹ ê²Œì‹œê¸€ì˜ pk ê°’ì´ ì‚¬ìš© ë˜ê³  ìˆìŒ
- ëŒ“ê¸€ì˜ ì™¸ë˜ í‚¤ ë°ì´í„°ì— í•„ìš”í•œ ì •ë³´ê°€ ë°”ë¡œ ê²Œì‹œê¸€ì˜ pk ê°’
- ì´ì „ì— í•™ìŠµí–ˆë˜ url ì„ í†µí•´ ë³€ìˆ˜ë¥¼ ë„˜ê¸°ëŠ” variable routing ì„ ì‚¬ìš©



```python
# articles/urls.py

urlpatterns = [
    ...,
    path('<int:pk>/comments/', views.comments_create, name='comments_create'),
]
```

```python
# articles/views.py

def comments_create(request, pk):
    article = Article.objects.get(pk=pk)
    comment_form = CommentForm(request.POST)
    if comment_form.is_valid():
        comment_form.save()
    return redirect('articles:detail', article.pk)
```

```django
<!-- articles/detail.html -->

  <form action="{% url 'articles:comments_create' article.pk %}" method="POST">
    {% csrf_token %}
    {{ comment_form }}
    <input type="submit">
  </form>
```

- ì‘ì„±ì„ ë§ˆì¹˜ê³  ë³´ë©´ article ê°ì²´ ì €ì¥ì´ ì´ë£¨ì–´ì§ˆ íƒ€ì´ë°ì´ ë³´ì´ì§€ ì•ŠìŒ
- ê·¸ë˜ì„œ `save()` ë©”ì„œë“œëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê¸° ì „ì— ê°ì²´ì— ëŒ€í•œ ì¶”ê°€ì ì¸ ì‘ì—…ì„ ì§„í–‰í•  ìˆ˜ ìˆë„ë¡ ì¸ìŠ¤í„´ìŠ¤ë§Œì„ ë°˜í™˜í•´ì£¼ëŠ” ì˜µì…˜ ê°’ì„ ì œê³µ



- save ë©”ì„œë“œì˜ commit ì˜µì…˜ì„ ì‚¬ìš©í•´ DBì— ì €ì¥ë˜ê¸° ì „  article ê°ì²´ ì €ì¥í•˜ê¸°

```python
# articles/views.py

def comments_create(request, pk):
    article = Article.objects.get(pk=pk)
    comment_form = CommentForm(request.POST)
    if comment_form.is_valid():
        comment = comment_form.save(commit=False)
        comment.article = article
        comment.save()
    return redirect('articles:detail', article.pk)
```



####  ğŸ’› the `save()` method

- `save(commit=False)`
  - "Create, but don't save the new instance."
  - ì•„ì§ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì§€ ì•Šì€ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜
  - ì €ì¥í•˜ê¸° ì „ì— ê°ì²´ì— ëŒ€í•œ ì‚¬ìš©ì ì§€ì • ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•  ë•Œ ìœ ìš©í•˜ê²Œ ì‚¬ìš©



#### ğŸ“¢ READ

- ì‘ì„±í•œ ëŒ“ê¸€ ëª©ë¡ ì¶œë ¥í•˜ê¸°
- íŠ¹ì • articleì— ìˆëŠ” ëª¨ë“  ëŒ“ê¸€ì„ ê°€ì ¸ì˜¨ í›„ contextì— ì¶”ê°€

```python
# aritlces/views.py

from .models import Article, Comment

def detail(request, pk):
    article = Article.objects.get(pk=pk)
    comment_form = CommentForm()
    comments = article.comment_set.all()
    context = {
        'article': article,
        'comment_form': comment_form,
        'comments': comments,
    }
    return render(request, 'articles/detail.html', context)
```

- detail í…œí”Œë¦¿ì—ì„œ ëŒ“ê¸€ ëª©ë¡ ì¶œë ¥í•˜ê¸°

```django
{% extends 'base.html' %}

{% block content %}
  ...
  <a href="{% url 'articles:index' %}">back</a>
  <hr>
  <h4>ëŒ“ê¸€ ëª©ë¡</h4>
  <ul>
    {% for comment in comments %}
    	<li>{{ comment.content }}</li>
    {% endfor %}
  </ul>
  <hr>
  ...
{% endblock content %}
```



#### ğŸ“¢ DELETE

- ëŒ“ê¸€ ì‚­ì œ êµ¬í˜„í•˜ê¸°

```python
# articles/urls.py

urlpatterns = [
    ...,
    path('<int:article_pk>/comments/<int:comment_pk>/delete/', views.comments_delete, name='comments_delete'),
]
```

```python
# articles/views.py

def comments_delete(request, article_pk, comment_pk):
    comment = Comment.objects.get(pk=comment_pk)
    comment.delete()
    return redirect('articles:detail', article_pk)
```

- ëŒ“ê¸€ì„ ì‚­ì œí•  ìˆ˜ ìˆëŠ” ë²„íŠ¼ì„ ê°ê°ì˜ ëŒ“ê¸€ ì˜†ì— ì¶œë ¥ë  ìˆ˜ ìˆë„ë¡ í•¨

```django
<!-- articles/detail.html -->

{% block content %}
  ...
  <h4>ëŒ“ê¸€ ëª©ë¡</h4>
  <ul>
    {% for comment in comments  %}
      <li>{{ comment.content }}</li>
      <form action="{% url 'articles:comments_delete' article.pk comment.pk %}" method="POST">
        {% csrf_token %}
        <input type="submit" value="DELETE">
      </form>
    {% endfor %}
  </ul>
  <hr>
  ...
{% endblock content %}
```



### ğŸ’¡ Comment ì¶”ê°€ ì‚¬í•­

- ëŒ“ê¸€ì— ê´€ë ¨ëœ ì•„ë˜ 2ê°€ì§€ ì‚¬í•­ì„ ì‘ì„±í•˜ë©´ì„œ ë§ˆë¬´ë¦¬í•˜ê¸°
  1. ëŒ“ê¸€ ê°œìˆ˜ ì¶œë ¥í•˜ê¸°
     1. DTL filter - length ì‚¬ìš©
     2. Queryset API -count() ì‚¬ìš©
  2. ëŒ“ê¸€ì´ ì—†ëŠ” ê²½ìš° ëŒ€ì²´ ì»¨í…ì¸  ì¶œë ¥í•˜ê¸°



#### ğŸ“¢ ëŒ“ê¸€ ê°œìˆ˜ ì¶œë ¥í•˜ê¸°

1. DTL filter - length ì‚¬ìš©

   ```django
   {{ comments|length }}
   
   {{ article.comment_set.all|length }}
   ```

2. Queryset API - count() ì‚¬ìš©

   ```django
   {{ comments.count }}
   
   {{ article.comment_set.count }}
   ```

- detail í…œí”Œë¦¿ì— ì‘ì„±í•˜ê¸°

  ```django
  <!-- articles/detail.html -->
  
  <h4>ëŒ“ê¸€ ëª©ë¡</h4>
  {% if comments %}
    <p><b>{{ comments|length }}ê°œì˜ ëŒ“ê¸€ì´ ìˆìŠµë‹ˆë‹¤.</b></p>
  {% endif %}
  ```



#### ğŸ“¢ ëŒ“ê¸€ì´ ì—†ëŠ” ê²½ìš° ëŒ€ì²´ ì»¨í…ì¸  ì¶œë ¥í•˜ê¸°

- DTL for empty í™œìš©í•˜ê¸°

```django
<!-- articles/detail.html -->

{% for comment in comments  %}
    <li>{{ comment.content }}
    <form action="{% url 'articles:comments_delete' article.pk comment.pk %}" method="POST">
      {% csrf_token %}
      <input type="submit" value="DELETE">
    </form>
  </li>
  {% empty %}
   <li>ëŒ“ê¸€ì´ ì—†ì–´ìš”..</li>
{% endfor %}
```



## ğŸ“Œ N:1 (Article - User)

- Article(N) - User(1)
- Article ëª¨ë¸ê³¼ User ëª¨ë¸ ê°„ ê´€ê³„ ì„¤ì •
- "0ê°œ ì´ìƒì˜ ê²Œì‹œê¸€ì€ 1ê°œì˜ íšŒì›ì— ì˜í•´ ì‘ì„± ë  ìˆ˜ ìˆìŒ"



### ğŸ’¡ Referencing the User model

#### ğŸ“¢ Django ì—ì„œ User ëª¨ë¸ì„ ì°¸ì¡°í•˜ëŠ” ë°©ë²•

1. `settings.AUTH_USER_MODEL`
   - ë°˜í™˜ ê°’: 'accounts.User' (ë¬¸ìì—´)
   - User ëª¨ë¸ì— ëŒ€í•œ ì™¸ë˜ í‚¤ ë˜ëŠ” M:N ê´€ê³„ë¥¼ ì •ì˜í•  ë•Œ ì‚¬ìš©
   - models.py ì˜ ëª¨ë¸ í•„ë“œì—ì„œ User ëª¨ë¸ì„ ì°¸ì¡°í•  ë•Œ ì‚¬ìš©
2. `get_user_model()`
   - ë°˜í™˜ ê°’ : User Object (ê°ì²´)
   - í˜„ì¬ í™œì„±í™”(active) ëœ User ëª¨ë¸ì„ ë°˜í™˜
   - ì»¤ìŠ¤í„°ë§ˆì´ì§•í•œ User ëª¨ë¸ì´ ìˆì„ ê²½ìš°ëŠ” Custom User ëª¨ë¸, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ Userë¥¼ ë°˜í™˜
   - models.pyê°€ ì•„ë‹Œ ë‹¤ë¥¸ ëª¨ë“  ê³³ì—ì„œ ìœ ì € ëª¨ë¸ì„ ì°¸ì¡°í•  ë•Œ ì‚¬ìš©



#### ğŸ“¢ ì •ë¦¬

- ë¬¸ìì—´ê³¼ ê°ì²´ë¥¼ ë°˜í™˜í•˜ëŠ” íŠ¹ì§•ê³¼ Djangoì˜ ë‚´ë¶€ì ì¸ ì‹¤í–‰ ì›ë¦¬ì— ê´€ë ¨ëœ ê²ƒì´ë¯€ë¡œ ì´ë ‡ê²Œë§Œ ì™¸ìš°ë„ë¡
- User ëª¨ë¸ì„ ì°¸ì¡°í•  ë•Œ
  - models.py ì—ì„œëŠ” `settings.AUTH_USER_MODEL`
  - ë‹¤ë¥¸ ëª¨ë“  ê³³ì—ì„œëŠ” `get_user_model()`



### ğŸ’¡ ëª¨ë¸ ê´€ê³„ ì„¤ì •

#### ğŸ“¢ Articleê³¼ User ê°„ ëª¨ë¸ ê´€ê³„ ì„¤ì •

- Article ëª¨ë¸ì— User ëª¨ë¸ì„ ì°¸ì¡°í•˜ëŠ” ì™¸ë˜ í‚¤ ì‘ì„±

```python
# articles/models.py

from django.conf import settings

class Article(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
```



#### ğŸ“¢ Migration ì§„í–‰

- ê¸°ì¡´ì— ì¡´ì¬í•˜ë˜ í…Œì´ë¸”ì— ìƒˆë¡œìš´ ì»¬ëŸ¼ì´ ì¶”ê°€ë­ì–´ã…‘ í•˜ëŠ” ìƒí™©ì´ê¸° ë•Œë¬¸ì— migrations íŒŒì¼ì´ ê³§ë°”ë¡œ ë§Œë“¤ì–´ì§€ì§€ ì•Šê³  ì¼ë ¨ì˜ ê³¼ì •ì´ í•„ìš”

```bash
$ python manage.py makemigrations
```

![image-20221005141947448](assets/image-20221005141947448.png)

- ì²«ë²ˆì§¸ í™”ë©´
  - ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ì»¬ëŸ¼ì€ NOT NULL ì œì•½ ì¡°ê±´ì´ ìˆê¸° ë•Œë¬¸ì— ë°ì´í„°ê°€ ì—†ì´ëŠ” ìƒˆë¡œ ì¶”ê°€ë˜ëŠ” ì™¸ë˜ í‚¤ í•„ë“œ user_idê°€ ìƒì„±ë˜ì§€ ì•ŠìŒ
  - ê·¸ë˜ì„œ ê¸°ë³¸ê°’ì„ ì–´ë–»ê²Œ ì‘ì„±í•  ê²ƒì¸ì§€ ì„ íƒí•´ì•¼ í•¨
  - 1ì„ ì…ë ¥í•˜ê³  Enterì§„í–‰ (ë‹¤ìŒ í™”ë©´ì—ì„œ ì§ì ‘ ê¸°ë³¸ ê°’ ì…ë ¥)

![image-20221005142044824](assets/image-20221005142044824.png)

- ë‘ë²ˆì§¸ í™”ë©´
  - article ì˜ user_idì— ì–´ë–¤ ë°ì´í„°ë¥¼ ë„£ì„ ê²ƒì¸ì§€ ì§ì ‘ ì…ë ¥í•´ì•¼ í•¨
  - ë§ˆì°¬ê°€ì§€ë¡œ 1 ì…ë ¥í•˜ê³  Enter ì§„í–‰
  - ê·¸ëŸ¬ë©´ ê¸°ì¡´ì— ì‘ì„±ëœ ê²Œì‹œê¸€ì´ ìˆë‹¤ë©´ ëª¨ë‘ 1ë²ˆ íšŒì›ì´ ì‘ì„±í•œ ê²ƒìœ¼ë¡œ ì²˜ë¦¬ë¨



### ğŸ’¡ CREATE

- ì¸ì¦ëœ íšŒì›ì˜ ê²Œì‹œê¸€ ì‘ì„± êµ¬í˜„í•˜ê¸°
- ì‘ì„±í•˜ê¸° ì „ ë¡œê·¸ì¸ì„ ë¨¼ì € ì§„í–‰í•œ ìƒíƒœë¡œ ì§„í–‰

#### ğŸ“¢ ArticleForm

- Article Form ì¶œë ¥ì„ í™•ì¸í•´ë³´ë©´ create í…œí”Œë¦¿ì—ì„œ ë¶ˆí•„ìš”í•œ í•„ë“œ (user) ê°€ ì¶œë ¥ë¨
- ì´ì „ì— CommentForm ì—ì„œ ì™¸ë˜ í‚¤ í•„ë“œ articleì´ ì¶œë ¥ë˜ëŠ” ìƒí™©ê³¼ ë™ì¼í•œ ìƒí™©
- user í•„ë“œë„ ë§ˆì°¬ê°€ì§€ë¡œ ì‚¬ìš©ìë¡œë¶€í„° ë°›ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ request ê°ì²´ë¥¼ í†µí•´ ê°€ì ¸ì™€ì•¼ í•¨



#### ğŸ“¢ ì™¸ë˜ í‚¤ ë°ì´í„° ëˆ„ë½

- ê²Œì‹œê¸€ ì‘ì„±ì‹œ `NOT NULL constraint failed: articles_comment.user_id` ì—ëŸ¬ ë°œìƒ

![image-20221005154546453](assets/image-20221005154546453.png)

- "NOT NULL ì œì•½ ì¡°ê±´ì´ ì‹¤íŒ¨í–ˆë‹¤. articles_comment í…Œì´ë¸”ì˜ user_id ì»¬ëŸ¼ì—ì„œ"
- ëŒ“ê¸€ ì‘ì„± ì‹œ ì™¸ë˜ í‚¤ì— ì €ì¥ë˜ì–´ì•¼ í•  ì‘ì„±ì ì •ë³´ê°€ ëˆ„ë½ ë˜ì—ˆê¸° ë•Œë¬¸

- ëŒ“ê¸€ ì‘ì„± ì‹œ ì‘ì„±ì ì •ë³´ê°€ í•¨ê»˜ ì €ì¥ë  ìˆ˜ ìˆë„ë¡ saveì˜ commit ì˜µì…˜ì„ í™œìš©

```python
# articles/views.py

def comments_create(request, pk):
    article = Article.objects.get(pk=pk)
    comment_form = CommentForm(request.POST)
    if comment_form.is_valid():
        comment = comment_form.save(commit=False)
        comment.article = article
        comment.user = request.user
        comment.save()
    return redirect('articles:detail', article.pk)
```









### ğŸ’¡ DELETE

#### ğŸ“¢ ê²Œì‹œê¸€ ì‚­ì œ ì‹œ ì‘ì„±ì í™•ì¸

- ì´ì œ ê²Œì‹œê¸€ì—ëŠ” ì‘ì„±ì ì •ë³´ê°€ í•¨ê»˜ ë“¤ì–´ìˆê¸° ë•Œë¬¸ì— í˜„ì¬ ì‚­ì œ ìš”ì²­í•˜ë ¤ëŠ” ì‚¬ëŒê³¼ ê²Œì‹œê¸€ì„ ì‘ì„±í•œ ì‚¬ëŒì„ ë¹„êµí•˜ì—¬ ë³¸ì¸ì˜ ê²Œì‹œê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆë„ë¡ í•¨

```python
# articles/views.py

@require_POST
def delete(request, pk):
    article = Article.objects.get(pk=pk)
    if request.user.is_authenticated:
        if request.user == article.user:
            article.delete()
            return redirect('articles:index')
    return redirect('articles:detail', article.pk)
```



### ğŸ’¡ UPDATE

- ìˆ˜ì •ë„ ë§ˆì°¬ê°€ì§€ë¡œ ìˆ˜ì •ì„ ìš”ì²­í•˜ë ¤ëŠ” ì‚¬ëŒê³¼ ê²Œì‹œê¸€ì„ ì‘ì„±í•œ ì‚¬ëŒì„ ë¹„êµí•˜ì—¬ ë³¸ì¸ì˜ ê²Œì‹œê¸€ë§Œ ìˆ˜ì • í•  ìˆ˜ ìˆë„ë¡ í•¨

```python
# articles/views.py

@login_required
@require_http_methods(['GET', 'POST'])
def update(request, pk):
    article = Article.objects.get(pk=pk)
    if request.user == article.user:
        if request.method == 'POST':
            form = ArticleForm(request.POST, instance=article)
            # form = ArticleForm(data=request.POST, instance=article)
            if form.is_valid():
                form.save()
                return redirect('articles:detail', article.pk)
        else:
            form = ArticleForm(instance=article)
    else:
        return redirect('articles:index')
    context = {
        'form': form,
        'article': article,
    }
    return render(request, 'articles/update.html', context)
```

- ì¶”ê°€ë¡œ í•´ë‹¹ ê²Œì‹œê¸€ì˜ ì‘ì„±ìê°€ ì•„ë‹ˆë¼ë©´, ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì„ ì¶œë ¥í•˜ì§€ ì•Šë„ë¡ í•¨

```django
<!-- darticles/detail.html -->

{% extends 'base.html' %}

{% block content %}
  ...
  {% if request.user == article.user %}
    <a href="{% url 'articles:update' article.pk %}">UPDATE</a>
    <form action="{% url 'articles:delete' article.pk %}" method="POST">
      {% csrf_token %}
      <input type="submit" value="DELETE">
    </form>
  {% endif %}
...
```



### ğŸ’¡ READ

#### ğŸ“¢ ê²Œì‹œê¸€ ì‘ì„±ì ì¶œë ¥

- index í…œí”Œë¦¿ê³¼ detail í…œí”Œë¦¿ì—ì„œ ê° ê²Œì‹œê¸€ì˜ ì‘ì„±ì ì¶œë ¥

```django
<!-- articles/index.html -->

{% extends 'base.html' %}

{% block content %}
  <h1>Articles</h1>
  {% if request.user.is_authenticated %}
    <a href="{% url 'articles:create' %}">CREATE</a>
  {% endif %}
  <hr>
  {% for article in articles %}
    <p><b>ì‘ì„±ì : {{ article.user }}</b></p>
    <p>ê¸€ ë²ˆí˜¸ : {{ article.pk }}</p>
    <p>ì œëª© : {{ article.title }}</p>
    <p>ë‚´ìš© : {{ article.content }}</p>
    <a href="{% url 'articles:detail' article.pk %}">ìƒì„¸ í˜ì´ì§€</a>
    <hr>
  {% endfor %}
{% endblock content %}
```

```django
<!-- articles/detail.html -->

{% extends 'base.html' %}

{% block content %}
  <h1>DETAIL</h1>
  <h2>{{ article.pk }}ë²ˆì§¸ ê¸€ì…ë‹ˆë‹¤.</h2>
  <hr>
  <p><b>ì‘ì„±ì : {{ article.user }}</b></p>
  <p>ì œëª© : {{ article.title }}</p>
  <p>ë‚´ìš© : {{ article.content }}</p>
  <p>ì‘ì„± ì‹œê° : {{ article.created_at }}</p>
  <p>ìˆ˜ì • ì‹œê° : {{ article.updated_at }}</p>
  <hr>
```



## ğŸ“Œ N:1 (Comment - User)

- Comment(N) - User(1)
  - Comment ëª¨ë¸ê³¼ User ëª¨ë¸ ê°„ ê´€ê³„ ì„¤ì •
- "0ê°œ ì´ìƒì˜ ëŒ“ê¸€ì€ 1ê°œì˜ íšŒì›ì— ì˜í•´ ì‘ì„± ë  ìˆ˜ ìˆìŒ"



### ğŸ’¡ ëª¨ë¸ ê´€ê³„ ì„¤ì •

- Comment ëª¨ë¸ì— User ëª¨ë¸ì„ ì°¸ì¡°í•˜ëŠ” ì™¸ë˜ í‚¤ ì‘ì„±

```python
# articles/models.py

class Comment(models.Model):
    article = models.ForeignKey(Article, on_delete=models.CASCADE, null=True)
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
    ...
```



- **Migration ì§„í–‰**



### ğŸ’¡ CREATE

- ì¸ì¦ëœ íšŒì›ì˜ ëŒ“ê¸€ ì‘ì„± êµ¬í˜„í•˜ê¸°
- ì‘ì„±í•˜ê¸° ì „ ë¡œê·¸ì¸ì„ ë¨¼ì € ì§„í–‰í•œ ìƒíƒœë¡œ ì§„í–‰



#### ğŸ“¢ CommentForm

![image-20221005150257228](assets/image-20221005150257228.png)

- CommentForm ì¶œë ¥ì„ í™•ì¸í•´ë³´ë©´ create í…œí”Œë¦¿ì—ì„œ ë¶ˆí•„ìš”í•œ í•„ë“œ(user)ê°€ ì¶œë ¥ë¨

- user í•„ë“œë„ ë§ˆì°¬ê°€ì§€ë¡œ ì‚¬ìš©ìë¡œë¶€í„° ë°›ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ request ê°ì²´ë¥¼ í†µí•´ ê°€ì ¸ì™€ì•¼ í•¨

```python
# articles/forms.py

class CommentForm(forms.ModelForm):
    
    class Meta:
        model = Comment
        exclude = ('article', 'user',)
```



#### ğŸ“¢ ì™¸ë˜ í‚¤ ë°ì´í„° ëˆ„ë½

- ëŒ“ê¸€ ì‘ì„± ì‹œ` NOT NULL constraint failed: articles_comment.user_id `ì—ëŸ¬ ë°œìƒ

  ![image-20221005151334376](assets/image-20221005151334376.png)

- "NOT NULL ì œì•½ ì¡°ê±´ì´ ì‹¤íŒ¨í–ˆë‹¤. articles_comment í…Œì´ë¸”ì˜ user_id ì»¬ëŸ¼ì—ì„œ"

- ëŒ“ê¸€ ì‘ì„± ì‹œ ì™¸ë˜ í‚¤ì— ì €ì¥ë˜ì–´ì•¼ í•  ì‘ì„±ì ì •ë³´ê°€ ëˆ„ë½ ë˜ì—ˆê¸° ë•Œë¬¸
- ëŒ“ê¸€ ì‘ì„± ì‹œ ì‘ì„±ì ì •ë³´ê°€ í•¨ê»˜ ì €ì¥ë  ìˆ˜ ìˆë„ë¡ save ì˜ commit  ì˜µì…˜ì„ í™œìš©

```python
# articles/views.py

def comments_create(request, pk):
    article = Article.objects.get(pk=pk)
    comment_form = CommentForm(request.POST)
    if comment_form.is_valid():
        comment = comment_form.save(commit=False)
        comment.article = article
        comment.user = request.user
        comment.save()
    return redirect('articles:detail', article.pk)
```





### ğŸ’¡ READ

#### ğŸ“¢ ëŒ“ê¸€ ì‘ì„±ì ì¶œë ¥

- detail í…œí”Œë¦¿ì—ì„œ ê° ê²Œì‹œê¸€ì˜ ì‘ì„±ì ì¶œë ¥

```django
<!-- articles/detail.html -->

{% extends 'base.html' %}

{% block content %}
  ...
  <h4>ëŒ“ê¸€ ëª©ë¡</h4>
  ...
  <ul>
    {% for comment in comments  %}
      <li>
        {{ comment.user }} - {{ comment.content }}
        <form action="{% url 'articles:comments_delete' article.pk comment.pk %}" method="POST">
          {% csrf_token %}
          <input type="submit" value="DELETE">
        </form>
   ...
```



### ğŸ’¡ DELETE

#### ğŸ“¢ ëŒ“ê¸€ ì‚­ì œ ì‹œ ì‘ì„±ì í™•ì¸

- ì´ì œ ëŒ“ê¸€ì—ëŠ” ì‘ì„±ì ì •ë³´ê°€ í•¨ê»˜ ë“¤ì–´ìˆê¸° ë•Œë¬¸ì— í˜„ì¬ ì‚­ì œë¥¼ ìš”ì²­í•˜ë ¤ëŠ” ì‚¬ëŒê³¼ ëŒ“ê¸€ì„ ì‘ì„±í•œ ì‚¬ëŒì„ ë¹„êµí•˜ì—¬ ë³¸ì¸ì˜ ëŒ“ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆë„ë¡ í•¨

```python
# articles/views.py

def comments_delete(request, article_pk, comment_pk):
    comment = Comment.objects.get(pk=comment_pk)
    if request.user == comment.user:
        comment.delete()
    return redirect('articles:detail', article_pk)
```

- ì¶”ê°€ë¡œ í•´ë‹¹ ëŒ“ê¸€ì˜ ì‘ì„±ìê°€ ì•„ë‹ˆë¼ë©´, ì‚­ì œ ë²„íŠ¼ì„ ì¶œë ¥í•˜ì§€ ì•Šë„ë¡ í•¨

```django
<!-- articles/detail.html --<

{% extends 'base.html' %}

{% block content %}
  ...
    <ul>
    {% for comment in comments  %}
      <li>
        {{ comment.user }} - {{ comment.content }}
        {% if request.user == comment.user %}
          <form action="{% url 'articles:comments_delete' article.pk comment.pk %}" method="POST">
            {% csrf_token %}
            <input type="submit" value="DELETE">
          </form>
        {% endif %}
        ...
```



### ğŸ’¡ ì¸ì¦ëœ ì‚¬ìš©ìì— ëŒ€í•œ ì ‘ê·¼ ì œí•œí•˜ê¸°

- `is_authenticated` ì™€ View decoratorë¥¼ í™œìš©í•˜ì—¬ ì½”ë“œ ì •ë¦¬í•˜ê¸°



#### ğŸ“¢ ì¸ì¦ëœ ì‚¬ìš©ìì¸ ê²½ìš°ì—ë§Œ ëŒ“ê¸€ ì‘ì„± ë° ì‚­ì œí•˜ê¸°

```python
# articles/views.py

@require_POST
def comments_create(request, pk):
    if request.user.is_authenticated:
        article = Article.objects.get(pk=pk)
        comment_form = CommentForm(request.POST)
        if comment_form.is_valid():
            comment = comment_form.save(commit=False)
            comment.article = article
            comment.user = request.user
            comment.save()
        return redirect('articles:detail', article.pk)
    return redirect('accounts:login')

@require_POST
def comments_delete(request, article_pk, comment_pk):
    if request.user.is_authenticated:
        comment = Comment.objects.get(pk=comment_pk)
        if request.user == articles.user:
            comment.delete()
        return redirect('articles:detail', article_pk)
```



#### ğŸ“¢ ë¹„ì¸ì¦ ì‚¬ìš©ìëŠ” CommentFormì„ ë³¼ ìˆ˜ ì—†ë„ë¡ í•˜ê¸°

```django
<!-- articles/detail.html -->

{% extends 'base.html' %}

{% block content %}
  ...
  <hr>
  {% if request.user.is_authenticated %}
    <form action="{% url 'articles:comments_create' article.pk %}" method="POST">
      {% csrf_token %}
      {{ comment_form }}
      <input type="submit">
    </form>
  {% else %}
    <a href="{% url 'accounts:login' %}">[ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.]</a>
  {% endif %}
{% endblock content %}
```



## ğŸ“Œ ë§ˆë¬´ë¦¬

- A many-to-one relationship
  - Foreign Key
  - Django Relationship fields
  - Related manager
- N:1 ëª¨ë¸ ê´€ê³„ ì„¤ì •
  1. Comment - Article
  2. Article - User
     - Referencing the User model
  3. Comment - User